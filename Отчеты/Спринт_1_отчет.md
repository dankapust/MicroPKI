# Отчёт по Спринту 1 — MicroPKI

**Цель спринта:** Заложить основу PKI — самоподписанный Root CA с защищённым хранением ключа, генерацией сертификата и базовым аудит-логированием.

---

## 1. Структура проекта (STR-1 … STR-5)

| Требование | Статус | Реализация |
|------------|--------|------------|
| STR-1 Git + `.gitignore` | Выполнено | `.gitignore` исключает `*.key.pem`, `*.pem`, `secrets/`, `venv/`, `__pycache__/`, `*.log` |
| STR-2 `README.md` | Выполнено | Название, описание, инструкции по установке, примеры CLI, список зависимостей |
| STR-3 `requirements.txt` / `pyproject.toml` | Выполнено | Оба файла; `cryptography>=42.0.0`, `pytest>=7.0` |
| STR-4 Логичная структура | Выполнено | `micropki/` (cli, ca, certificates, crypto_utils, logger), `tests/`, `scripts/` |
| STR-5 Запуск тестов | Выполнено | `make test` → `pytest tests/ -v` |

---

## 2. CLI (CLI-1 … CLI-6)

| Требование | Статус | Реализация |
|------------|--------|------------|
| CLI-1 Вызов как `micropki` | Выполнено | entry point в `pyproject.toml`; также `python -m micropki` через `__main__.py` |
| CLI-2 `ca init`, расширяемый парсер | Выполнено | argparse с subparsers: `ca init`, `ca verify`; легко добавить новые |
| CLI-3 Аргументы | Выполнено | `--subject`, `--key-type`, `--key-size`, `--passphrase-file`, `--out-dir`, `--validity-days`, `--log-file` |
| CLI-4 Валидация входных данных | Выполнено | DN, key-type/key-size, passphrase-file, out-dir, validity-days; ошибки в stderr + non-zero exit |
| CLI-5 Безопасная работа с passphrase | Выполнено | Чтение как bytes, strip `\n\r`, не выводится, не логируется |
| CLI-6 Защита от перезаписи | Выполнено | Без `--force` — отказ с ошибкой; с `--force` — перезапись |

---

## 3. PKI (PKI-1 … PKI-5)

| Требование | Статус | Реализация |
|------------|--------|------------|
| PKI-1 Генерация ключей | Выполнено | RSA 4096 через `rsa.generate_private_key()`; ECC P-384 через `ec.generate_private_key(SECP384R1())` |
| PKI-2 Самоподписанный X.509v3 | Выполнено | Serial из `os.urandom(19)` (≤159 бит, CSPRNG); Subject = Issuer; RSA→SHA-256, ECC→SHA-384 |
| PKI-3 Расширения | Выполнено | BasicConstraints(CA=TRUE, pathLength=None) critical; KeyUsage(keyCertSign, cRLSign, digitalSignature) critical; SKI через `from_public_key()` по RFC 5280; AKI = SKI |
| PKI-4 PEM-кодирование | Выполнено | `-----BEGIN CERTIFICATE-----` (RFC 7468) |
| PKI-5 Вывод в `certs/ca.cert.pem` | Выполнено | Путь: `<out-dir>/certs/ca.cert.pem` |

---

## 4. Хранение ключа (KEY-1 … KEY-4)

| Требование | Статус | Реализация |
|------------|--------|------------|
| KEY-1 Шифрование ключа | Выполнено | `BestAvailableEncryption(passphrase)`, формат PKCS#8 |
| KEY-2 Вывод в `private/ca.key.pem` | Выполнено | Путь: `<out-dir>/private/ca.key.pem` |
| KEY-3 Права доступа | Выполнено | `private/` — 0o700, `ca.key.pem` — 0o600; на Windows — предупреждение в лог |
| KEY-4 Структура каталогов | Выполнено | `private/`, `certs/`, `policy.txt` |

---

## 5. Политика и логи (POL-1, LOG-1 … LOG-3)

| Требование | Статус | Реализация |
|------------|--------|------------|
| POL-1 `policy.txt` | Выполнено | DN, serial (hex), NotBefore/NotAfter, алгоритм+размер ключа, назначение, версия 1.0, дата |
| LOG-1 Инфраструктура логирования | Выполнено | `--log-file` → файл (каталог создаётся авто); без — stderr; ISO 8601 с мс, уровень, сообщение |
| LOG-2 Обязательные события | Выполнено | Начало/конец генерации ключа, начало/конец подписания, сохранение key/cert (полный путь), policy |
| LOG-3 Редакция пароля | Выполнено | Passphrase не появляется в логах; тест `test_cli_ca_init_log_file` проверяет это |

---

## 6. Тестирование (TEST-1 … TEST-6)

| Требование | Статус | Тест |
|------------|--------|------|
| TEST-1 Самоверификация сертификата | Выполнено | `micropki ca verify --cert <path>`; тест `test_cli_ca_init_and_verify_self_signed` |
| TEST-2 Совпадение ключ–сертификат | Выполнено | `scripts/verify_key_cert_match.py` |
| TEST-3 Загрузка зашифрованного ключа | Выполнено | `test_encrypted_key_roundtrip` — сохранение, загрузка, подпись, верификация |
| TEST-4 Негативные сценарии | Выполнено | Нет `--subject`, невалидный DN, ecc+256, нет passphrase-file, незаписываемый `--out-dir`, перезапись без `--force` |
| TEST-5 Юнит-тесты (≥2) | Выполнено | 22 теста: DN-парсинг, PEM roundtrip, расширения сертификата, генерация ключей, лог-файл |
| TEST-6 Совместимость с OpenSSL | Документировано | Процедура описана в README: `openssl verify -CAfile ... ...` |

**Результат прогона:** 22 passed, 0 failed.

---

## 7. Файлы проекта, затронутые в Спринте 1

```
Kripta/
├── .gitignore                          # исключения для Git (ключи, venv, артефакты)
├── README.md                           # описание, установка, примеры CLI, зависимости
├── requirements.txt                    # cryptography>=42.0.0, pytest>=7.0
├── pyproject.toml                      # пакет, entry point micropki, pytest config
├── Makefile                            # make test → pytest
│
├── micropki/
│   ├── __init__.py                     # версия пакета
│   ├── __main__.py                     # python -m micropki
│   ├── cli.py                          # argparse: ca init, ca verify; валидация
│   ├── ca.py                           # Root CA: init, policy, verify
│   ├── certificates.py                 # X.509 v3: DN, BC, KU, SKI, AKI
│   ├── crypto_utils.py                 # RSA/ECC, PEM, BestAvailableEncryption, passphrase
│   └── logger.py                       # ISO 8601 + мс, файл/stderr
│
├── tests/
│   ├── __init__.py                     # пакет тестов
│   ├── test_certificates.py            # DN-парсинг, PEM roundtrip, расширения сертификата
│   ├── test_crypto_utils.py            # генерация ключей, passphrase, зашифрованный roundtrip
│   └── test_ca_init_cli.py             # CLI: негативные кейсы, init+verify, ECC, лог, overwrite
│
├── scripts/
│   └── verify_key_cert_match.py        # TEST-2: подпись ключом → верификация сертификатом
│
├── Отчеты/
│   └── Спринт_1_отчет.md              # этот файл
│
└── (генерируемые при запуске, в Git не попадают)
    ├── secrets/
    │   └── ca.pass                     # файл с passphrase
    └── pki/
        ├── private/
        │   └── ca.key.pem              # зашифрованный приватный ключ Root CA
        ├── certs/
        │   └── ca.cert.pem             # самоподписанный сертификат Root CA
        └── policy.txt                  # документ политики CA
```

**Всего файлов проекта (исходники + тесты + скрипты + конфиг):** 17.

---

## 8. Исправления и оптимизации по результатам ревью

В ходе аудита были выявлены и исправлены:

1. **SKI (Subject Key Identifier)** — ранее хешировался весь `SubjectPublicKeyInfo` DER вместо только `subjectPublicKey` BIT STRING. Исправлено на `x509.SubjectKeyIdentifier.from_public_key()` в соответствии с RFC 5280 s4.2.1.2.
2. **Серийный номер** — библиотека `cryptography` 46.x ограничивает серийный номер до 159 бит. Сокращено с 20 до 19 байт случайных данных.
3. **CertificateBuilder API** — в `cryptography` 46.x метод переименован: `.not_valid_before_utc()` → `.not_valid_before()`. Исправлено.
4. **Дублирование логов** — сохранение ключа логировалось дважды (в `crypto_utils.write_private_key_pem` и в `ca.init_root_ca`). Убран дубликат.
5. **`__main__.py`** — добавлен, теперь `python -m micropki` работает корректно.
6. **Каталог для лог-файла** — теперь создаётся автоматически (например, `--log-file logs/ca-init.log`).
7. **Парсер ошибок CLI** — `_parser` теперь ссылается на подкоманду `init`, а не на корневой парсер.
8. **Добавлены тесты:** ECC-инициализация, проверка содержимого лог-файла и обязательных событий (LOG-2), проверка отсутствия пароля в логах (LOG-3), незаписываемый `--out-dir` (TEST-4), проверка расширений сертификата (PKI-3).

---

## 9. Итог

Все требования Sprint 1 (STR, CLI, PKI, KEY, POL, LOG, TEST) выполнены. Криптография реализована исключительно через библиотеку `cryptography` без собственных примитивов. Тестовый набор из 22 тестов покрывает позитивные и негативные сценарии, правильность расширений X.509v3, логирование и безопасность.
